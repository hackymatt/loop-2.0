name: Continuous Improvement

on:
  pull_request:
    branches: [develop]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      broker: ${{ steps.filter.outputs.broker }}
      sandbox-python: ${{ steps.filter.outputs.sandbox-python }}
    steps:
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          token: ${{ secrets.PAT_FOR_FILTER }}
          filters: |
            backend:
              - 'backend/**'
            frontend:
              - 'frontend/**'
            broker:
              - 'broker/**'
            sandbox-python:
              - 'sandbox/python/**'

  lint-backend:
    uses: ./linting/backend.yml
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'

  lint-broker:
    uses: ./linting/broker.yml
    needs: detect-changes
    if: needs.detect-changes.outputs.broker == 'true'

  lint-frontend:
    uses: ./linting/frontend.yml
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'

  lint-python-sandbox:
    uses: ./linting/sandbox/python.yml
    needs: detect-changes
    if: needs.detect-changes.outputs.sandbox-python == 'true'

  test-backend:
    uses: ./testing/backend.yml
    needs: lint-backend
    if: needs.detect-changes.outputs.backend == 'true'

  test-broker:
    uses: ./testing/broker.yml
    needs: lint-broker
    if: needs.detect-changes.outputs.broker == 'true'

  test-frontend:
    uses: ./testing/frontend.yml
    needs: lint-frontend
    if: needs.detect-changes.outputs.frontend == 'true'

  test-python-sandbox:
    uses: ./testing/sandbox/python.yml
    needs: lint-python-sandbox
    if: needs.detect-changes.outputs.sandbox-python == 'true'
